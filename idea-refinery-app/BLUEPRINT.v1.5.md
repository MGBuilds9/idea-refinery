# BLUEPRINT ARCHITECT v1.5: IDEA REFINERY
> **Version:** 1.5.0 (Engineering Grade)
> **Status:** RELEASED (February 10, 2026)
> **Deferred to v2:** Team collaboration (organization_id), plugin system (custom agents), billing/SaaS model
> **Platform:** Web PWA + Native Mobile (Capacitor)
> **Stack:** Vite React, Dexie.js (Local), Node/Express (Self-Hosted), PostgreSQL (Docker)

---

# PART 0: CORE ARCHITECTURE & PHILOSOPHY

## 0.1 The Core Mechanism: "The Spec Object"
Unlike v1.4 which treated ideas as text, v1.5 treats an Idea as a **Structured Data Object**. Text is just the display layer.

**The "Idea Spec" JSON Schema:**
We essentially build a "compiler" that turns this JSON into the final Markdown Blueprint.
```typescript
interface IdeaSpec {
  meta: {
    id: string;
    version: number;
    name: string;
    tagline: string;
    target_audience: Persona[];
  };
  features: FeatureBlock[];
  tech_stack: {
    frontend: string;
    backend: string;
    database: string;
    auth: string;
  };
  data_model: SchemaEntity[];
  design: {
    theme_name: string;
    primary_color: string;
    mood: string;
  };
}

interface FeatureBlock {
  id: string;
  title: string;
  user_story: string;
  acceptance_criteria: string[]; // These become checklist items in the output
  complexity: 'low' | 'medium' | 'high';
}
```

## 0.2 The Prompt Chain Strategy (Three-Agent System)
We do not ask one AI to "write the blueprint". We orchestrate three distinct "Agents" (Personas) to build the Spec Object.

| Agent | Role | System Prompt Focus |
|-------|------|---------------------|
| **The Architect** | Structure & Scope | "You are a Senior Systems Architect. Your job is to define the capabilities, constraints, and data models. You ignore UI." |
| **The Designer** | UX & Visuals | "You are a Product Designer. Your job is to define the user journey, the 'vibe', and the component hierarchy. You ignore database schemas." |
| **The Critic** | Validation & Gap Analysis | "You are a QA Lead and Security Expert. Your job is to find logical loops, missing auth checks, and unclear requirements." |

## 0.3 Explicit Assumptions & Constraints
| Assumption | Impact on Engineering |
|------------|-----------------------|
| **Self-Hosted Sovereign** | No cloud dependencies allowed. Must run via `docker-compose up`. |
| **Local-First (Dexie)** | The app must work perfectly offline. Sync is a background enhancement. |
| **BYO-Intelligence** | User provides API Keys (Anthropic/OpenAI/Gemini). |

---

# PART 1: STRATEGIC FOUNDATION

## 1.1 The "Refinery" Pipeline (Revised)
1.  **Ingestion:** User dumps raw text.
2.  **Structuring (Agent 1):** AI attempts to map raw text into the `IdeaSpec` JSON.
3.  **Gap Detection (Agent 3):** AI identifies `null` fields in the `IdeaSpec`.
4.  **Interrogation:** AI generates specific questions to fill the `null`s.
5.  **Rendering:** The filled `IdeaSpec` is compiled into `BLUEPRINT.md`.
6.  **Mockup Injection (Agent 2):** The Designer agent reads the `features` array and generates HTML/Tailwind for the key views.

## 1.2 Metrics of Success
-   **"One-Shot Accuracy"**: When the user takes our export to Cursor/Bolt, does it run without error? Target > 90%.
-   **Structure Density**: Does the blueprint contain actual SQL/Typescript interfaces? (Yes/No).

---

# PART 2: TECH STACK & CONFIGURATION

## 2.1 Core Stack (The "Sovereign" Box)
-   **Frontend:** React 19 + Vite + Capacitor (iOS)
-   **Backend:** Node.js (Express) - *Stateless API*
-   **Database:** PostgreSQL 16 (Docker)
-   **Local DB:** Dexie.js (IndexedDB)
-   **Deployment:** `docker-compose.yml` containing [App, API, Postgres]

## 2.2 Connectivity Architecture
Since the backend is self-hosted on the user's machine (e.g., Mac Mini) and the client is on their iPhone:
1.  **Discovery:** The iOS app needs a "Connect to Server" screen.
2.  **Scanning:** User enters `http://192.168.x.x:3000` or scans a QR code generated by the desktop app.
3.  **Sync Protocol:** Dexie.js (Client) <-> REST API <-> PostgreSQL (Server).

## 2.3 Safety & Validation Configuration
We prevent the AI from suggesting hallucinations by anchoring it to a "Tech Allowlist".

```typescript
// src/config/tech-allowlist.ts
export const ALLOWED_MODULES = {
  frontend: ['framer-motion', 'lucide-react', 'clsx', 'tailwind-merge'],
  backend: ['express', 'cors', 'helmet', 'zod'],
  database: ['pg', 'knex', 'prisma'],
};

// If the AI suggests a package NOT in this list, the "Critic" agent flags it.
```

---

# PART 2A: SYSTEM PROMPTS (The Brains)

We explicitly define the "personality" and "instructions" for each agent in the chain. These are the source of truth.

## 2A.1 The Architect (Logic & Structure)
**Goal:** Transform ambiguity into a structured `IdeaSpec` JSON.

```markdown
# System Prompt: THE ARCHITECT

**ROLE:**
You are a Senior Systems Architect and CTO. You do not care about colors or fonts. You care about SCALABILITY, DATA INTEGRITY, and LOGIC.

**OBJECTIVE:**
Take the user's raw idea and output a valid `IdeaSpec` JSON object.

**CRITICAL RULES:**
1.  **No UI Descriptions:** Do not say "The screen is blue". Say "The Dashboard View requires a `RecentProjects` component".
2.  **Strict Schema:** You must output valid JSON matching the `IdeaSpec` interface.
3.  **Assume Self-Hosted:** The stack is always React/Node/Postgres/Dexie. Do not suggest Firebase or AWS Lambda unless explicitly requested.
4.  **Identify Feature Gaps:** If the user says "I want a store", you must infer "Product Management", "Cart", "Checkout", and "Order History" features.

**OUTPUT FORMAT:**
Return ONLY the JSON object. No preamble.
```

## 2A.2 The Designer (UI & UX)
**Goal:** Take the `IdeaSpec` and generate the visual layer code/HTML.

```markdown
# System Prompt: THE DESIGNER

**ROLE:**
You are a World-Class UI/UX Designer who codes. You specialize in "Premium Utility" aesthetics (Linear, Vercel, Stripe style).

**OBJECTIVE:**
Read the `IdeaSpec` features and generate:
1.  The `tailwind.config.js` theme customization.
2.  The HTML/Tailwind structure for the core components.

**DESIGN TOKENS:**
-   **Primary:** #d4af37 (Muted Gold)
-   **Background:** #09090b (Zinc 950)
-   **Surface:** rgba(255,255,255,0.05) (Glassmorphism)
-   **Radius:** '0.5rem' (Small, tight corners)

**CRITICAL RULES:**
1.  **Mobile First:** All layouts must work on 375px screens.
2.  **No Placeholders:** Never say "Insert map here". Create the `div` with the correct aspect ratio and background color.
3.  **Interactive States:** Always include `:hover` and `:active` classes on buttons.
```

## 2A.3 The Critic (Validation & QA)
**Goal:** Review the outputs of Architect and Designer for safety/logic errors.

```markdown
# System Prompt: THE CRITIC

**ROLE:**
You are the Lead Security Engineer and QA Tester. You are pessimistic and detail-oriented.

**OBJECTIVE:**
Review the proposed Plan and Code for:
1.  **Security Risks:** (e.g., storing API keys in localstorage without encryption).
2.  **Hallucinations:** (e.g., using a library that doesn't exist).
3.  **Logic Loops:** (e.g., A requires B, but B requires A).

**RESPONSE FORMAT:**
If PASS: Return "STATUS: APPROVED".
If FAIL: Return a numbered list of issues with severity (HIGH/MED/LOW).
```

---

# PART 3: THE DESIGN SYSTEM ("The Gold Standard")

## 3.1 Design Tokens (Tailwind Config)
We enforce a strict aesthetic. The generated HTML Mockups *must* use these tokens.

```javascript
// tailwind.config.js
export default {
  theme: {
    extend: {
      colors: {
        background: "hsl(var(--background))", // #09090b
        foreground: "hsl(var(--foreground))", // #fafafa
        primary: {
          DEFAULT: "hsl(var(--primary))", // #d4af37 (Gold)
          foreground: "hsl(var(--primary-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))", // rgba(255,255,255,0.05)
          foreground: "hsl(var(--card-foreground))",
        },
      },
      fontFamily: {
        sans: ["Inter", "sans-serif"],
        mono: ["JetBrains Mono", "monospace"],
      },
    }
  }
}
```

## 3.2 Visual Components for the Refinery
-   **The Diff Viewer:** A specialized component that shows (OLD Text) vs (NEW Text) when the Architect proposes a change.
-   **The Feature Card:** A UI representation of a `FeatureBlock`. Drag-and-drop to reorder priority.
-   **The "Export Flight Deck":** A complex modal with toggles for every part of the export package.

---

# PART 4: DATA LAYER (Strict Schemas)

## 4.1 Postgres Migration
Moving from generic JSONB to relational integrity where it matters.

```sql
-- Projects Table
create table projects (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  name text not null,
  description text,
  status text check (status in ('draft', 'refined', 'exported')) default 'draft',
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Features Table (The "Spec Object" unpacked)
create table features (
  id uuid primary key default gen_random_uuid(),
  project_id uuid references projects on delete cascade,
  title text not null,
  description text,
  priority text check (priority in ('low', 'medium', 'high')),
  status text default 'pending'
);

-- Artifacts (Versioning)
create table artifacts (
  id uuid primary key default gen_random_uuid(),
  project_id uuid references projects on delete cascade,
  version int not null,
  type text check (type in ('blueprint_md', 'cursor_rules', 'mockup_html')),
  content text not null, -- The actual generated string
  created_at timestamptz default now()
);
```

---

# PART 5: OUTPUT & EXPORT STRATEGY

This is the product. The app is a "Specification Factory".

## 5.1 Export Format: "The Implementation Plan"
We generate a file exactly like the one this agent uses.
-   **Filename:** `implementation_plan.md`
-   **Structure:**
    -   `## User Review Required` (Changes to Auth/Billing/Data)
    -   `## Proposed Changes` (File by File breakdown)
    -   `## Verification Plan` (How to test)

## 5.2 Export Format: "The Cursor Rules" (`.cursorrules`)
We generate a tailored rules file for the user's specific project stack.
*Example Content Generated:*
```markdown
# .cursorrules
- Stack: React, Vite, Tailwind
- Style: Functional Components, Hooks
- Rules:
  - Use `lucide-react` for icons.
  - Use `zod` for all form validation.
  - STRICT: No `any` types.
```

## 5.3 Export Format: "The Context Dump" (`prompt.md`)
A massive single-file markdown designed to be pasted into Claude/ChatGPT web UI.
-   Contains the entire Project Spec.
-   Contains the entire Design System.
-   Contains the "First Instruction" (e.g., "Set up the project structure...").

---

# PART 6: GAP ANALYSIS (Self-Correction)

## 6.1 What is still missing?
-   **Billing Model Integration:** If this becomes a SaaS, where is the subscription logic? (Currently assuming BYOK / pure local).
-   **Team Collaboration:** The current DB schema assumes single-user ownership (`user_id`). No `organization_id` yet.
-   **Plugin System:** Can users add their own "Agents" or "Templates"? (V2 feature).

## 6.2 The "Prompt Injection" Risk
-   **Risk:** User puts malicious instructions in the "Idea" field.
-   **Mitigation:** The "Architect" agent has a system instruction to sanitize input and refuse to generate harmful code specs.

---

# PART 7: IMPLEMENTATION ROADMAP (The Path Forward)

1.  **Database Migration:** Update Supabase schema to match Part 4.
2.  **Agent Integration:** Build the `AgentOrchestrator` service to handle the Architect/Designer/Critic loop.
3.  **UI Overhaul:** Implement the "Feature Card" drag-and-drop interface.
4.  **Export Engine:** Build the template string generators for `.cursorrules` and `implementation_plan.md`.
